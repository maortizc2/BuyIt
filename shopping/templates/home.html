{% extends "base.html" %} {% load static %} {% block content %}
<main class="container mx-auto px-4 py-8 md:py-16">
  <h1
    class="text-4xl md:text-6xl font-bold text-sky-600 text-center mb-4 animate-fade-in"
  >
    BuyIt
  </h1>
  <p
    class="text-lg md:text-xl text-sky-800 text-center mb-8 max-w-2xl mx-auto animate-fade-in-up"
  >
    BuyIt es una plataforma para comparar productos según tus gustos y
    necesidades.
  </p>

  {% if user.is_authenticated %}
  <form id="compare-form" class="grid md:grid-cols-3 gap-8 mt-12">
    {% csrf_token %} {% for producto in productos %}
    <div
      class="relative bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 group"
    >
      <input
        type="checkbox"
        value="{{ producto.id }}"
        class="hidden comparar-checkbox"
      />
      <div class="absolute top-4 right-4 z-10">
        <button
          type="button"
          class="bg-sky-600 text-white px-3 py-1 text-xs rounded hover:bg-sky-700 select-button"
        >
          Comparar
        </button>
      </div>
      <img
        src="{{ producto.productPicture }}"
        alt="{{ producto.productName }}"
        class="w-full h-48 object-cover rounded-lg mb-4"
      />
      <h2 class="text-xl font-semibold text-sky-700 mb-2">
        {{ producto.productName }}
      </h2>
      <p class="text-sky-600 mb-2">{{ producto.productDescription }}</p>
      <p class="text-sky-800 font-bold">Precio: ${{ producto.productPrice }}</p>
      <a
        href="{{ producto.productBuyLink }}"
        target="_blank"
        class="block text-center bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105 mt-4"
      >
        Comprar Ahora
      </a>
    </div>
    {% empty %}
    <p class="text-center text-gray-500 col-span-3">
      No hay productos disponibles.
    </p>
    {% endfor %}
  </form>

  <div id="compare-bar" class="compare-bar hidden">
    <span class="font-semibold text-white"
      >Comparar 2 productos seleccionados</span
    >
    <button
      onclick="enviarComparacion()"
      class="bg-white text-sky-600 font-bold px-6 py-2 rounded hover:bg-sky-100 transition"
    >
      Comparar
    </button>
  </div>

  <form
    id="real-compare-form"
    method="post"
    action="{% url 'comparar_productos' %}"
    class="hidden"
  >
    {% csrf_token %}
    <input type="hidden" name="producto_a" id="producto_a_input" />
    <input type="hidden" name="producto_b" id="producto_b_input" />
  </form>

  {% else %}
  <div class="text-center">
    <h2 class="text-3xl font-bold text-sky-700 mb-4">Acceso Restringido</h2>
    <p class="text-sky-600 mb-4">
      Debes registrarte o iniciar sesión para ver los productos.
    </p>
    <a
      href="{% url 'accounts:register' %}"
      class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-full transition"
    >
      Registrarse
    </a>
    <span class="mx-2">o</span>
    <a
      href="{% url 'accounts:login' %}"
      class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-full transition"
    >
      Iniciar Sesión
    </a>
  </div>
  {% endif %}
</main>

<style>
  .compare-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #0284c7;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
    transition: all 0.3s ease;
  }
</style>

<script>
  const checkboxes = document.querySelectorAll(".comparar-checkbox");
  const compareBar = document.getElementById("compare-bar");
  const selectButtons = document.querySelectorAll(".select-button");
  const selectedStorage = JSON.parse(
    localStorage.getItem("selectedProducts") || "[]"
  );

  function updateCompareState() {
    const selected = Array.from(checkboxes).filter((cb) => cb.checked);
    compareBar.classList.toggle("hidden", selected.length !== 2);
    checkboxes.forEach((cb) =>
      cb
        .closest("div")
        .classList.remove("ring", "ring-4", "ring-sky-500", "scale-105")
    );
    selected.forEach((cb) =>
      cb
        .closest("div")
        .classList.add("ring", "ring-4", "ring-sky-500", "scale-105")
    );
    if (selected.length === 2) {
      checkboxes.forEach((cb) => {
        if (!cb.checked) cb.disabled = true;
      });
    } else {
      checkboxes.forEach((cb) => (cb.disabled = false));
    }
    localStorage.setItem(
      "selectedProducts",
      JSON.stringify(selected.map((cb) => cb.value))
    );
  }

  function enviarComparacion() {
    const seleccionados = Array.from(checkboxes).filter((cb) => cb.checked);
    if (seleccionados.length === 2) {
      document.getElementById("producto_a_input").value =
        seleccionados[0].value;
      document.getElementById("producto_b_input").value =
        seleccionados[1].value;
      document.getElementById("real-compare-form").submit();
    } else {
      alert("Selecciona exactamente 2 productos para comparar.");
    }
  }

  selectButtons.forEach((btn, i) => {
    btn.addEventListener("click", () => {
      const cb = checkboxes[i];
      cb.checked = !cb.checked;
      updateCompareState();
    });
  });

  checkboxes.forEach((cb) => {
    if (selectedStorage.includes(cb.value)) cb.checked = true;
  });
  updateCompareState();
</script>
{% endblock %}
